---
title: "CVE-2020-1337: my two cents"
date: 2020-08-11T20:00:06+01:00
description: "In this post the vulnerability catalogued as CVE-2020-1048 will be analysed; after that a bypass method will be described that will allow us to develop a binary planting PoC (CVE-2020-1337)."
draft: false
hideToc: true
enableToc: false
enableTocContent: false
author: neofito
authorImage: "https://avatars3.githubusercontent.com/u/1921186?s=400&u=6b86038f075e0813761c512d25e0917744741b61&v=4"
socialOptions:
  twitter: "https://twitter.com/neosysforensics"
  github: "https://github.com/neofito"
tags:
- Windows
- EoP
- CVE-2020-1337
categories:
- Windows
- Exploitation
image: 
---

In January of this year, Peleg Hadar ([@peleghd](https://twitter.com/peleghd)) and Tomer Bar reported to Microsoft, without publicly releasing any details, a Windows Print Spooler vulnerability that could allow privilege elevation from Windows 7 onwards. The security updates intended for that vulnerability ([CVE-2020-1048](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1048)) were released by Microsoft on May 12. 

On the same day, Alex Ionescu ([@aionescu](https://twitter.com/aionescu)) and Yarden Shafir ([@yarden_shafir](https://twitter.com/yarden_shafir)), who collided discovering the vulnerability, published a very detailed blog post about it: [PrintDemon: Print Spooler Privilege Escalation, Persistence & Stealth (CVE-2020-1048 & more)](https://windows-internals.com/printdemon-cve-2020-1048/). Using this knowledge and after some tests, I was able to find a bypass for the security updates released by Microsoft mainly via [junction points and symlinks](https://vimeo.com/133002251) (kudos to James Forshaw [@tiraniddo](https://twitter.com/tiraniddo)).

My report, sent on May 19, was marked by Microsoft as duplicated, colliding with other [researchers](https://twitter.com/neosysforensics/status/1293191989635289088). The vulnerability was catalogued as [CVE-2020-1337](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1337), and shared with [these persons](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1337#Acknowledgements).

In this post I'll try to summarize the CVE-2020-1048 vulnerability exploitation process and the subsequent bypass found by me, plus some detailed references to read.

## CVE-2020-1048

As I explained above, on May 12 of this same year Microsoft released the [CVE-2020-1048](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1048) security updates:

> An elevation of privilege vulnerability exists when the Windows Print Spooler service improperly allows arbitrary writing to the file system. An attacker who successfully exploited this vulnerability could run arbitrary code with elevated system privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.
>
> To exploit this vulnerability, an attacker would have to log on to an affected system and run a specially crafted script or application.
>
> The update addresses the vulnerability by correcting how the Windows Print Spooler Component writes to the file system.

[Yarden Shafir](https://twitter.com/yarden_shafir) and [Alex Ionescu](https://twitter.com/aionescu) published his blogpost [PrintDemon: Print Spooler Privilege Escalation, Persistence & Stealth (CVE-2020-1048 & more)](https://windows-internals.com/printdemon-cve-2020-1048/) giving detailed clues about the vulnerability and its exploitation without releasing a functional PoC, or at least not "_as is_".

The exploitation process requires to create a specially crafted local printer port and a virtual printer with a generic driver. The printer port has to point to a file in a restricted path, i.e. `C:\Windows\system32\evil.dll`, because during its creation Windows doesn't check the user privileges to write in this path. If a standard user launches a print job later through this virtual printer, an error will be prompted because the user is not allowed to write in that path; the printing job is executed via [impersoation](https://docs.microsoft.com/en-us/windows/win32/secauthz/client-impersonation) and that is the normal behavior, isn't it?

Note that to point the local pointer to the `C:\Windows\system32` path and later be able to create the virtual printer using this port with a generic driver it has to be done via PowerShell or programmatically; using the UI printer wizard will cause an _Access denied_ error to be returned because the system will check the privileges before even writing the file.

![Access denied while creating a local printer port](/posts/CVE-2020-1337_mis_dos_centavos/001.png)

The [blog post](https://windows-internals.com/printdemon-cve-2020-1048/), that I encourage all of you to read, deepens in the process done by the Windows print spooler and its print jobs. When a print job is launched two different kind of files are created in the `C:\Windows\system32\spool\PRINTERS` directory:

- `FPnnnnn.SPL` or `nnnnn.SPL` with the content to be printed. 
- `FPnnnnn.SHD` or `nnnnn.SHD` with all the metadata related to the print job.

I'm not describing the `SHD` file format because this knowledge is not an essential requirement to understand the exploitation process (see [this](https://github.com/ionescu007/PrintDemon) and [this](https://github.com/SafeBreach-Labs/Spooler)). As short, when the spooler service is started it searchs for shadow files (`.SHD`) on his default directory (`C:\Windows\system32\spool\PRINTERS` habitually) checking its content and launching the printing of the associated spool file (`.SPL`) doing this as `SYSTEM` without impersonating the owner user. Now, puzzling all the details it is posible to build a functional PoC.

Using Visual Studio to open the original [solution](https://github.com/ionescu007/PrintDemon), we will first modify the `printserver\pserver.c` file as described next:

{{< highlight c >}}
    LPWSTR g_PortName = L"c:\\windows\\system32\\evil.dll";
{{< /highlight >}}

We will also modify the `hPrinter` and `hMonitor` variable declaration:

{{< highlight c >}}
    HANDLE hPrinter = NULL;
    HANDLE hMonitor = NULL;
{{< /highlight >}}

Next we include the `strsafe.h` header and the next code fragment from this [post](https://stackoverflow.com/questions/14002954/c-programming-how-to-read-the-whole-file-contents-into-a-buffer) at stackoverflow, that will be in charge for storing the malicious DLL content in memory:

{{< highlight c >}}
    FILE* f;
    wchar_t wDirPath[MAX_PATH];
    DWORD dRet;

    dRet = GetCurrentDirectory(MAX_PATH, wDirPath);
    if (dRet == 0)
    {
        printf("GetCurrentDirectory failed (%d)\n", GetLastError());
        goto CleanupPath;
    }
    wcscat_s(wDirPath, sizeof(wDirPath), L"\\evil.dll");

    _wfopen_s(&f, wDirPath, L"rb");
    fseek(f, 0, SEEK_END);
    long fsize = ftell(f);
    fseek(f, 0, SEEK_SET);

    char* string = malloc(fsize + 1);
    fread(string, 1, fsize, f);
    fclose(f);

    printf("[.] Reading evil.dll: %d bytes\n", fsize);
{{< /highlight >}}

Note: the [Windows Driver Kit](https://docs.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk) [must be previously installed](https://github.com/ionescu007/SpecuCheck/issues/5) in order to compile the project because the `ntdllp.lib` has to be found.

Finally, as a standard user in a Windows 10 system without the [CVE-2020-1048](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1048) security update we will launch the `printserver.exe` with our `evil.dll` in the same path:

![Running the printserver binary](/posts/CVE-2020-1337_mis_dos_centavos/002.png)

The execution will be stopped waiting for our interaction; without restarting the execution we can check that a new printer has been added, PrintDemon, with a print job paused:

![PrintDemon with a print job paused](/posts/CVE-2020-1337_mis_dos_centavos/003.png)

To reboot the `spooler` service as a standard user we have to reboot the system. Once the system has started we'll restart the print job queue:

![Print job queue restart](/posts/CVE-2020-1337_mis_dos_centavos/004.png)

As a result our malicious file has been planted on `C:\Windows\system32`: 

![Malicious file on system32](/posts/CVE-2020-1337_mis_dos_centavos/005.png)

We can use the malicious DLL also released by [Yarden Shafir](https://twitter.com/yarden_shafir) and [Alex Ionescu](https://twitter.com/aionescu) with [Faxing Your Way to SYSTEM â€” Part Two](https://windows-internals.com/faxing-your-way-to-system/), published April 30, to accomplish a DLL hijacking attack in order to escalate privileges to system. That process will not be discussed in this article but I think it is slightly described by me on [twitter](https://twitter.com/neosysforensics/status/1260850582384005121).

A few days after the release of [PrintDemon](https://github.com/ionescu007/PrintDemon), more precisely May 15, BC Security ([@BCSecurity1](https://twitter.com/BCSecurity1)), actual maintainer of the [Empire](https://github.com/BC-SECURITY/Empire/) framework, release a PowerShell [exploit](https://github.com/BC-SECURITY/Invoke-PrintDemon). Probably my fault but I have to say that the exploit is not functional [without a spooler service reboot](https://twitter.com/BCSecurity1/status/1261287868103680002).

On the other hand, on the past day August 5 Peleg Hadar ([@peleghd](https://twitter.com/peleghd)) and Tomer Bar released all the details about the CVE-2020-1048 on both talks on [Black Hat](https://www.blackhat.com/us-20/briefings/schedule/index.html#a-decade-after-stuxnets-printer-vulnerability-printing-is-still-the-stairway-to-heaven-19685) and DEF CON ([video](https://www.youtube.com/watch?v=RvABLQpiZks), [slides](https://media.defcon.org/DEF%20CON%2028/DEF%20CON%20Safe%20Mode%20presentations/DEF%20CON%20Safe%20Mode%20-%20Peleg%20Hadar%20-%20A%20Decade%20After%20Stuxnet%27s%20Printer%20Vulnerability%20Printing%20is%20still%20the%20Stairway%20to%20Heaven.pdf) y [whitepaper](https://media.defcon.org/DEF%20CON%2028/DEF%20CON%20Safe%20Mode%20presentations/DEF%20CON%20Safe%20Mode%20-%20Peleg%20Hadar%20-%20A%20Decade%20After%20Stuxnet%27s%20Printer%20Vulnerability%20Printing%20is%20still%20the%20Stairway%20to%20Heaven%20wp.pdf)). The [exploit](https://github.com/SafeBreach-Labs/Spooler/tree/master/SHDWriter) and additional material could be found on [github](https://github.com/SafeBreach-Labs/Spooler).

## My bypass for CVE-2020-1048

After the PrintDemon device deletion and the corresponding [update]((https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1048)) installation we will initiate anew the virtual printer creation process using the next PowerShell command:

![Virtual printer creation error](/posts/CVE-2020-1337_mis_dos_centavos/006.png)

As showed above we will get an access denied error trying to create the local printer port. The security update added some checks for the correct write privileges on the specified path, blocking the process at this point; but wait, are you sure the process is completely blocked? We will need to find a trick to bypass this check...

First we will install a generic printer driver; we will also create a new directory that we will later use as the print job destination:

![Generic driver and directory creation](/posts/CVE-2020-1337_mis_dos_centavos/007.png)

After that we will add a local printer port pointing to a file on this directory and we will confirm that everything went well:

![Local printer port creation](/posts/CVE-2020-1337_mis_dos_centavos/008.png)

The process will end correctly because our standard user has write privileges on the specified directory. Finally we will add the virtual printer device using the local printer port and the generic driver:

![Virtual printer device creation](/posts/CVE-2020-1337_mis_dos_centavos/009.png)

At this moment we will pause the virtual printer:

![Pausando la impresora virtual](/posts/CVE-2020-1337_mis_dos_centavos/010.png)

Now we will send a test printer job that will be paused on the printer queue:

![Virtual printer queue on pause](/posts/CVE-2020-1337_mis_dos_centavos/011.png)

Using our standard user we will reboot the system. Now, what could we do to print our file content on a privileged path? The answer is using the [symboliclink-testing-tools](https://github.com/googleprojectzero/symboliclink-testing-tools) released by [James Forshaw](https://twitter.com/tiraniddo).

Without going into specifics ([more details](https://vimeo.com/133002251)) we will generate a junction point for the directory pointed by our local printer port, `C:\Users\me\test`, and later we will use a symbolic link to point `C:\Users\me\test\foobar` to `C:\windows\system32\evil.dll`:

![Creating the symlinks](/posts/CVE-2020-1337_mis_dos_centavos/012.png)

If we restart the paused printer queue we will accomplish the creation of the `C:\windows\system32\evil.dll`:

![Malicious file creation](/posts/CVE-2020-1337_mis_dos_centavos/013.png)

Once the bypass was confirmed I developed a [C# PoC](https://github.com/neofito/CVE-2020-1337) using  [NtApiDotNet](https://www.nuget.org/packages/NtApiDotNet/) by [James Forshaw](https://twitter.com/tiraniddo) to programmatically create the required symlinks and [IlMerge 3.0.40](https://www.nuget.org/packages/ilmerge/3.0.40) plus [MSBuild.ILMerge.Task](https://www.nuget.org/packages/MSBuild.ILMerge.Task/) to get the final binary. After making [some questions](https://twitter.com/neosysforensics/status/1262660686800437251) and several tests I got a functional PoC.

The first execution requires to use as arguments the first step plus the path of our malicious file; after that we will need to reboot the system:

![BinaryPlanting.exe first step](/posts/CVE-2020-1337_mis_dos_centavos/014.png)

Once the system has started we will use as arguments of the binary the final step plus the name of the file that will be created on `C:\Windows\system32`:

![BinaryPlanting.exe last step](/posts/CVE-2020-1337_mis_dos_centavos/015.png)

As a result we will have planted our malicious DLL on `C:\Windows\system32` allowing us to execute a DLL hijacking to elevate privileges on a vulnerable system.

## Useful links

- [CVE-2020-1048 | Windows Print Spooler Elevation of Privilege Vulnerability](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1048)
- [PrintDemon: Print Spooler Privilege Escalation, Persistence & Stealth (CVE-2020-1048 & more)](https://windows-internals.com/printdemon-cve-2020-1048/)
- [PrintDemon (CVE-2020-1048)](https://github.com/ionescu007/PrintDemon)
- [Invoke-PrintDemon](https://github.com/BC-SECURITY/Invoke-PrintDemon)
- [DEF CON Safe Mode - Peleg Hadar and Tomer Bar - After Stuxnet Printing still the Stairway to Heaven](https://www.youtube.com/watch?v=RvABLQpiZks)
- [Print Spooler Research Tools](https://github.com/SafeBreach-Labs/Spooler)
- [Windows Print Spooler Patch Bypass Re-Enables Persistent Backdoor](https://www.zerodayinitiative.com/blog/2020/8/11/windows-print-spooler-patch-bypass-re-enables-persistent-backdoor)
- [CVE-2020-1337 Windows Privilege Escalation](https://github.com/math1as/CVE-2020-1337-exploit)
- [CVE-2020-1337 â€“ PrintDemon is dead, long live PrintDemon!](https://voidsec.com/cve-2020-1337-printdemon-is-dead-long-live-printdemon/)
- [cve-2020-1337-poc](https://github.com/sailay1996/cve-2020-1337-poc) 
- [CVE-2020-1337 - Binary Planting (CVE-2020-1048 bypass)](https://github.com/neofito/CVE-2020-1337)